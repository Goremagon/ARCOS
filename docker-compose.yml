services:
  # Service 1: The Rust Brain (Risk & Reporting)
  maestro:
    build:
      context: .
      dockerfile: Dockerfile.maestro
    environment:
      - REDIS_URL=redis://redis:6379
      - PORT=8080
      - ARCOS_WORKSPACE=/app/workspace
      - ARCOS_DB_PATH=/app/workspace/arcos_vault.db
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - ALERT_RECIPIENT=${ALERT_RECIPIENT}
    depends_on:
      - agent
      - redis

  # Service 2: The Python Worker (Data & ML)
  agent:
    build:
      context: .
      dockerfile: Dockerfile.agent
    user: root 
    working_dir: /app
    environment:
      - REDIS_URL=redis://redis:6379
      - PORT=8080
      - ARCOS_WORKSPACE=/app/workspace
      - ARCOS_DB_PATH=/app/workspace/arcos_vault.db
    # NEW: Allow Agent to see Windows Localhost
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - redis

  # Service 3: The Dashboard (UI)
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile.agent 
    user: root
    volumes:
      # FIX: Use ${PWD} so it reads from D:\Arcos\workspace
      - ${PWD}/workspace:/app/workspace
      - ${PWD}/dashboard.py:/app/dashboard.py
    command: streamlit run dashboard.py --server.port 8501 --server.address 0.0.0.0
    ports:
      - "8501:8501"
    environment:
      - ARCOS_WORKSPACE=/app/workspace
      - ARCOS_DB_PATH=/app/workspace/arcos_vault.db

  calibrator:
    build:
      context: .
      dockerfile: Dockerfile.agent
    command: python -u calibrator.py
    volumes:
      - ${PWD}/workspace:/app/workspace
    environment:
      - ARCOS_WORKSPACE=/app/workspace
      - ARCOS_DB_PATH=/app/workspace/arcos_vault.db
    depends_on:
      - redis

  # Service 4: Redis (Message Broker)
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
